---
title: redis事务控制
date: 2017-11-07 21:28:21
tags:
- redis
---

关系型数据库事务的特征：
1. 原子性
2. 一致性
3. 隔离性
4. 持久性

单个的redis命令是原子性的，但是redis没有在事务上增加维持原子性的机制，所以redis的事务执行不具有原子性。
redis的事务可以理解为一个打包的批量操作，但批量指令并非原子化操作，所以中间的某条指令失败不会导致前面已经成功的指令回滚，也不会影响后续指令的结果。

<!-- more -->

**事务控制命令：**

命令 | 描述
---|---
discard | 取消事务，放弃执行事务块内的所有命令
exec | 执行所有事务块内的命令
multi | 标记一个事务块的开始
watch key[key..] | 监视key，如果在事务执行之前这个key被其他命令修改，打断事务
unwatch | 取消watch命令对key的监视

一个事务从开始到执行会经历：
- 开始事务
- 命令入队
- 执行事务

批量的操作会在exec命令前被放入队列缓存，收到exec命令后会按照队列规则进行执行（失败不中断）。**在事务执行过程中，其它事务不会影响当前事务的处理队列。（事务隔离性）**

```
127.0.0.1:6379> set name "xiaopeng"
QUEUED
127.0.0.1:6379> set country "china"
QUEUED
127.0.0.1:6379> exec
1) OK
2) OK
127.0.0.1:6379> get name
"xiaopeng"
127.0.0.1:6379> get country
"china"
127.0.0.1:6379> 
```

假设set name "xiaopeng" 执行出错，但是set country "china" 仍然会继续执行。

# 总结
redis的事务可以保证以下两点：
1. 事务中的所有命令，要么全部执行，要么全部不执行（执行exec前已经全部加入队列）
2. 事务具有隔离性，支持并发操作

